import ttkbootstrap as ttk
from tkinter import messagebox, END, INSERT
import json
import os
from .user_manager import add_user, check_user

HISTORY_FILE = "login_history.json"

def load_history():
    """بارگذاری تاریخچه"""
    if os.path.exists(HISTORY_FILE):
        try:
            with open(HISTORY_FILE, 'r', encoding='utf-8') as f:
                return json.load(f)
        except:
            return {"usernames": [], "passwords": {}}
    return {"usernames": [], "passwords": {}}

def save_history(username, password):
    """ذخیره تاریخچه"""
    history = load_history()
    if username not in history["usernames"]:
        history["usernames"].insert(0, username)  # اضافه کردن به اول
        history["usernames"] = history["usernames"][:10]
    else:
        # انتقال به اول اگر وجود داشت
        history["usernames"].remove(username)
        history["usernames"].insert(0, username)
    
    history["passwords"][username] = password
    
    with open(HISTORY_FILE, 'w', encoding='utf-8') as f:
        json.dump(history, f, ensure_ascii=False, indent=2)

class AutocompleteEntry(ttk.Entry):
    """Entry با autocomplete درون فیلد"""
    
    def __init__(self, parent, autocomplete_list, *args, **kwargs):
        super().__init__(parent, *args, **kwargs)
        self.autocomplete_list = autocomplete_list
        self.autocompleted = False
        
        # اتصال event ها
        self.bind('<KeyRelease>', self.on_keyrelease)
        self.bind('<Key>', self.on_keypress)
        
    def on_keyrelease(self, event):
        """وقتی کلید رها شد"""
        # نادیده گرفتن کلیدهای خاص
        if event.keysym in ('BackSpace', 'Left', 'Right', 'Up', 'Down', 
                           'Delete', 'Home', 'End', 'Tab', 'Return'):
            return
        
        typed = self.get()
        if typed == '':
            return
        
        # پیدا کردن اولین مورد منطبق
        for item in self.autocomplete_list:
            if item.lower().startswith(typed.lower()):
                # پاک کردن و نوشتن متن کامل
                cursor_pos = self.index(INSERT)
                self.delete(0, END)
                self.insert(0, item)
                # انتخاب قسمت پیشنهادی
                self.select_range(cursor_pos, END)
                self.icursor(cursor_pos)
                self.autocompleted = True
                break
    
    def on_keypress(self, event):
        """وقتی کلید فشرده شد"""
        # اگر متن autocomplete وجود دارد و کاربر تایپ می‌کند
        if self.autocompleted and len(event.keysym) == 1:
            # حذف قسمت انتخاب شده
            if self.selection_present():
                cursor = self.index(INSERT)
                self.delete(cursor, END)
                self.autocompleted = False
        
        # با فلش راست قبول کردن پیشنهاد
        if event.keysym == 'Right':
            if self.selection_present():
                self.icursor(END)
                self.selection_clear()
                return "break"
    
    def update_list(self, new_list):
        """به‌روزرسانی لیست پیشنهادها"""
        self.autocomplete_list = new_list

def show_login(frame, on_login):
    for widget in frame.winfo_children():
        widget.destroy()
    
    history = load_history()

    # نام کاربری با autocomplete
    ttk.Label(frame, text="نام کاربری", style="TLabel").pack(pady=10)
    username_var = ttk.StringVar()
    username_entry = AutocompleteEntry(
        frame, 
        autocomplete_list=history["usernames"],
        textvariable=username_var,
        style="TEntry"
    )
    username_entry.pack(pady=10)
    
    # رمز عبور با autocomplete
    ttk.Label(frame, text="کلمه عبور", style="TLabel").pack(pady=10)
    password_var = ttk.StringVar()
    password_entry = ttk.Entry(
        frame, 
        textvariable=password_var,
        show="*",
        style="TEntry"
    )
    password_entry.pack(pady=10)
    
    # وقتی نام کاربری تکمیل شد، رمز را پر کن
    def check_username(event):
        username = username_var.get()
        if username in history["passwords"]:
            password_var.set(history["passwords"][username])
    
    username_entry.bind('<FocusOut>', check_username)
    username_entry.bind('<Return>', check_username)
    
    def login_user():
        username = username_var.get()
        password = password_var.get()
        if check_user(username, password):
            save_history(username, password)
            # به‌روزرسانی لیست autocomplete
            username_entry.update_list(load_history()["usernames"])
            on_login(username)
        else:
            messagebox.showerror("خطا", "نام کاربری یا کلمه عبور صحیح نمی باشد")

    def register_user():
        username = username_var.get()
        password = password_var.get()
        
        if add_user(username, password):
            save_history(username, password)
            username_entry.update_list(load_history()["usernames"])
            messagebox.showinfo("ثبت نام موفق", "کاربر با موفقیت ایجاد شد")
        else:
            messagebox.showwarning("ثبت نام ناموفق", "کاربر ایجاد نشد")

    ttk.Button(frame, text="ورود", command=login_user).pack(pady=5)
    ttk.Button(frame, text="ثبت نام", command=register_user).pack(pady=5)
